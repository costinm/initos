#!/bin/sh

# Separate script for setting up server machines with TPM2
# All servers should have TPM2 in order to start automatically.
# Without TPM2 - it is possible to start in a locked mode and 
# connect to a control plane for further instructions.
#
# In case of problems (failure to unlock, can't ssh):
# -disable secure mode (may require BIOS password)
# -boot from a USB image if disk is completely gone.
# 


# Main entry point - called by the init script
initos_init() {  
  logi "Starting INITOS TPM2 $(uname -r)"

  # Additional drivers with the real firmware and modules mounted. 
  load_drivers

  if [ -f /boot/efi/initos/tpm_handle ]; then 
    unlock_tpm

    open_disks "$KEY"
  else
    for i in 1 2 3; do
      echo
      echo -n "Enter the disk (LUKS) password (attempt $i of 3): "
      read -s KEY

      open_disks "$KEY"
      
      if [ -e /dev/mapper/luks-1 ]; then
        break
      fi

      echo
      echo "Failed to unlock the disk. Please try again."
    done
  fi 

  # LUKS mounted on /x, secure mode.

  # At this point we may have a tpm and may be able to mount
  # encrypted disk.
  # If insecure - the TPM should NOT have the key
  # Without TPM2 - will ask for a password - if it can open the
  # disk - ok, otherwise panic
  mount_btrfs_raw /dev/mapper/luks-1 /x
  if [ $? -eq 0 ]; then
      logi "BTRFS mounted"
  else
      lfatal "Failed to mount btrfs"
  fi

  start_os

  ln -s /etc/init.d/agetty /etc/init.d/agetty.tty1
  /etc/init.d/agetty.tty1 start

  exec tini -s sleep -- infinity 

}


. /sbin/initos

